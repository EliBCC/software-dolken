!!! warning "These module docs are in beta and may be incomplete."

# modm:architecture:register: General Purpose Registers

Data structures to provide a native register abstraction.

These data structures are used to describe the relationship of single bits,
bit groups and bit configurations in registers with type-safe access.

Registers can be made up of three things:

- Bits: a single bit (position N),
- Configurations: a combination of bits where the meaning does not correspond to its numeric value (position [N, M])
- Values: a numeric value (position [N, M])

Example of an 8-bit register called Control

```
   7    6    5      4      3      2      1    0
| EN | FS | PRE1 | PRE0 | DEL2 | DEL1 | DEL0 | |
```

- Bit 7: Enable
- Bit 6: Full Scale
- Configuration [5, 4]: Prescaler
    - 00: Divide by 1
    - 01: Divide by 2
    - 10: Divide by 4
    - 11: Divide by 8
- Value [3, 1]: Start-Up Delay in ms

## Register Bits

The bits can be modelled using strongly-typed enums and the Flags template class as follows:

```cpp
enum class
Control : uint8_t
{
    EN = Bit7,	///< bit documentation
    FS = Bit6,

    PRE1 = Bit5,
    PRE0 = Bit4,

    DEL2 = Bit3,
    DEL1 = Bit2,
    DEL0 = Bit1,
};
MODM_FLAGS8(Control);
// expands to
// typedef modm::Flags8< Control >  Control_t;
// and some enum operator overloading magic
```

You can handle all its register bits as you would expect:

```cpp
Control_t control = Control::EN;
control = Control::EN | Control::FS;
control &= ~Control::FS;
control |= Control::FS;
control ^= Control::PRE1;
bool isSet = control & Control::FS;

control.reset(Control::PRE1 | Control::PRE0);
control.set(Control::DEL0);

bool noneSet = control.none(Control::PRE1 | Control::PRE0);
bool allSet = control.all(Control::EN | Control::FS);
```

You still get raw access if you really need it:

```cpp
uint8_t raw = control.value; // the underlying type
control.value = 0x24;
```

The access is type-safe, you cannot use bits from two different registers:

```cpp
enum class Control2 : uint8_t
{
    DIS = Bit4,
    HS = Bit3,
};
MODM_FLAGS8(Control2);

auto control = Control::EN | Control2::HS; // compile error
```

You can even overload functions on argument type now:

```cpp
void write(Control_t control);
void write(Control2_t control);

write(Control::EN | Control::FS);  // calls #1
write(Control2::DIS);              // calls #2
```


## Register Configurations

Configurations are also described as a strongly-typed enum and then wrapped into the Configuration template class.

```cpp
enum class
Prescaler : uint8_t
{
    Div1 = 0,				///< configuration documentation
    Div2 = int(Control::PRE0),
    Div4 = int(Control::PRE1),
    Div8 = int(Control::PRE1) | int(Control::PRE0),
};
typedef Configuration< Control_t, Prescaler, (Bit5 | Bit4) >  Prescaler_t;
```

The `Prescaler` enum values are already shifted in this example (hence the `(Bit5 | Bit4)` mask), however you can also declare the prescaler values non-shifted and let the wrapper shift it:

```cpp
enum class Prescaler : uint8_t
{
    Div1 = 0,
    Div2 = 1,
    Div4 = 2,
    Div8 = 3,
};
typedef Configuration<Control_t, Prescaler, 0b11, 4> Prescaler_t;
```

Why? If you have two or more configurations with the same selections in the same register,  you can simply add another one:

```cpp
typedef Configuration< Control_t, Prescaler, 0b11, 6 >  Prescaler2_t;
```

Configurations can be used inline:

```cpp
Control_t control = Control::EN | Prescaler_t(Prescaler::Div2);
Control_t control &= ~Prescaler_t::mask();
```

But do not have to:

```cpp
Prescaler_t::set(control, Prescaler::Div2);
Prescaler_t::reset(control);
Prescaler prescaler = Prescaler_t::get(control);
```


## Register Values

Values are described using the Value template class which masks and shifts the value as required.
In our example the value has a width of 3 bits and needs to be shifted 1 bit:

```cpp
typedef Value< Control_t, 3, 1 >  Delay_t;
```

This can be used the same way as the Configuration:

```cpp
Control_t control = Control::EN | Prescaler_t(Prescaler::Div2) | Delay_t(4);
Control_t control &= ~Delay_t::mask();

Delay_t::set(control, 7);
Delay_t::reset(control);
uint8_t delay = Delay_t::get(control);
```

See [Typesafe Register Access in C++](http://blog.modm.io/2015/02/25/typesafe-register-access-in-c++)
for a more detailed background on this implementation.






## Dependencies

<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: modm:architecture:register Pages: 1 -->
<svg width="263pt" height="239pt"
 viewBox="0.00 0.00 262.50 239.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 235)">
<title>modm:architecture:register</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-235 258.5,-235 258.5,4 -4,4"/>
<!-- modm_architecture_register -->
<g id="node1" class="node"><title>modm_architecture_register</title>
<polygon fill="lightgrey" stroke="black" stroke-width="2" points="178,-142 94,-142 94,-89 178,-89 178,-142"/>
<text text-anchor="middle" x="136" y="-126.8" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="136" y="-111.8" font-family="Times New Roman,serif" font-size="14.00">architecture:</text>
<text text-anchor="middle" x="136" y="-96.8" font-family="Times New Roman,serif" font-size="14.00">register</text>
</g>
<!-- modm_architecture -->
<g id="node2" class="node"><title>modm_architecture</title>
<g id="a_node2"><a xlink:href="../modm-architecture" xlink:title="modm:
architecture">
<polygon fill="lightgrey" stroke="black" points="89.5,-223.5 8.5,-223.5 8.5,-185.5 89.5,-185.5 89.5,-223.5"/>
<text text-anchor="middle" x="49" y="-208.3" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="49" y="-193.3" font-family="Times New Roman,serif" font-size="14.00">architecture</text>
</a>
</g>
</g>
<!-- modm_architecture_register&#45;&gt;modm_architecture -->
<g id="edge1" class="edge"><title>modm_architecture_register&#45;&gt;modm_architecture</title>
<path fill="none" stroke="black" d="M110.368,-142.132C98.9373,-153.563 85.5148,-166.985 74.1424,-178.358"/>
<polygon fill="black" stroke="black" points="71.6029,-175.947 67.0067,-185.493 76.5526,-180.897 71.6029,-175.947"/>
</g>
<!-- modm_io -->
<g id="node3" class="node"><title>modm_io</title>
<g id="a_node3"><a xlink:href="../modm-io" xlink:title="modm:
io">
<polygon fill="lightgrey" stroke="black" points="164,-223.5 108,-223.5 108,-185.5 164,-185.5 164,-223.5"/>
<text text-anchor="middle" x="136" y="-208.3" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="136" y="-193.3" font-family="Times New Roman,serif" font-size="14.00">io</text>
</a>
</g>
</g>
<!-- modm_architecture_register&#45;&gt;modm_io -->
<g id="edge2" class="edge"><title>modm_architecture_register&#45;&gt;modm_io</title>
<path fill="none" stroke="black" d="M136,-142.132C136,-152.583 136,-164.699 136,-175.391"/>
<polygon fill="black" stroke="black" points="132.5,-175.493 136,-185.493 139.5,-175.493 132.5,-175.493"/>
</g>
<!-- modm_math_utils -->
<g id="node4" class="node"><title>modm_math_utils</title>
<g id="a_node4"><a xlink:href="../modm-math-utils" xlink:title="modm:
math:
utils">
<polygon fill="lightgrey" stroke="black" points="238,-231 182,-231 182,-178 238,-178 238,-231"/>
<text text-anchor="middle" x="210" y="-215.8" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="210" y="-200.8" font-family="Times New Roman,serif" font-size="14.00">math:</text>
<text text-anchor="middle" x="210" y="-185.8" font-family="Times New Roman,serif" font-size="14.00">utils</text>
</a>
</g>
</g>
<!-- modm_architecture_register&#45;&gt;modm_math_utils -->
<g id="edge3" class="edge"><title>modm_architecture_register&#45;&gt;modm_math_utils</title>
<path fill="none" stroke="black" d="M157.802,-142.132C165.188,-150.816 173.553,-160.65 181.387,-169.861"/>
<polygon fill="black" stroke="black" points="178.953,-172.401 188.098,-177.75 184.285,-167.865 178.953,-172.401"/>
</g>
<!-- modm_architecture_memory -->
<g id="node5" class="node"><title>modm_architecture_memory</title>
<g id="a_node5"><a xlink:href="../modm-architecture-memory" xlink:title="modm:
architecture:
memory">
<polygon fill="lightgrey" stroke="black" points="84,-53 0,-53 0,-0 84,-0 84,-53"/>
<text text-anchor="middle" x="42" y="-37.8" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="42" y="-22.8" font-family="Times New Roman,serif" font-size="14.00">architecture:</text>
<text text-anchor="middle" x="42" y="-7.8" font-family="Times New Roman,serif" font-size="14.00">memory</text>
</a>
</g>
</g>
<!-- modm_architecture_memory&#45;&gt;modm_architecture_register -->
<g id="edge4" class="edge"><title>modm_architecture_memory&#45;&gt;modm_architecture_register</title>
<path fill="none" stroke="black" d="M69.6947,-53.1323C79.3615,-62.0792 90.347,-72.2467 100.557,-81.6962"/>
<polygon fill="black" stroke="black" points="98.462,-84.5264 108.178,-88.7503 103.217,-79.389 98.462,-84.5264"/>
</g>
<!-- modm_platform_spi -->
<g id="node6" class="node"><title>modm_platform_spi</title>
<g id="a_node6"><a xlink:href="../modm-platform-spi" xlink:title="modm:
platform:
spi">
<polygon fill="lightgrey" stroke="black" points="169.5,-53 102.5,-53 102.5,-0 169.5,-0 169.5,-53"/>
<text text-anchor="middle" x="136" y="-37.8" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="136" y="-22.8" font-family="Times New Roman,serif" font-size="14.00">platform:</text>
<text text-anchor="middle" x="136" y="-7.8" font-family="Times New Roman,serif" font-size="14.00">spi</text>
</a>
</g>
</g>
<!-- modm_platform_spi&#45;&gt;modm_architecture_register -->
<g id="edge5" class="edge"><title>modm_platform_spi&#45;&gt;modm_architecture_register</title>
<path fill="none" stroke="black" d="M136,-53.1323C136,-61.1144 136,-70.0679 136,-78.6164"/>
<polygon fill="black" stroke="black" points="132.5,-78.7502 136,-88.7503 139.5,-78.7503 132.5,-78.7502"/>
</g>
<!-- modm_platform_uart -->
<g id="node7" class="node"><title>modm_platform_uart</title>
<g id="a_node7"><a xlink:href="../modm-platform-uart" xlink:title="modm:
platform:
uart">
<polygon fill="lightgrey" stroke="black" points="254.5,-53 187.5,-53 187.5,-0 254.5,-0 254.5,-53"/>
<text text-anchor="middle" x="221" y="-37.8" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="221" y="-22.8" font-family="Times New Roman,serif" font-size="14.00">platform:</text>
<text text-anchor="middle" x="221" y="-7.8" font-family="Times New Roman,serif" font-size="14.00">uart</text>
</a>
</g>
</g>
<!-- modm_platform_uart&#45;&gt;modm_architecture_register -->
<g id="edge6" class="edge"><title>modm_platform_uart&#45;&gt;modm_architecture_register</title>
<path fill="none" stroke="black" d="M195.957,-53.1323C187.301,-61.9915 177.477,-72.0474 168.321,-81.4181"/>
<polygon fill="black" stroke="black" points="165.643,-79.1515 161.158,-88.7503 170.65,-84.0434 165.643,-79.1515"/>
</g>
</g>
</svg>

