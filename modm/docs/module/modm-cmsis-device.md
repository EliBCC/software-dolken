!!! warning "These module docs are in beta and may be incomplete."

# modm:cmsis:device: STM32 CMSIS Headers

This module wraps [the CMSIS headers for STM32 devices][repo] and provides the
header file and CPP definitions for accessing the `modm:target` peripherals.
Specifically, it copies the target header file which provides the CMSIS
implementation of the target's language interface for its memory-mapped
peripherals.

!!! bug "Discrepancies between documentation and headers"
    These CMSIS headers should reflect what's written in the documentation,
    however, in our experience there may be small differences in naming,
    behavior and availability between it and this implementation.
    Since ST is not interested in addressing these issues, please contribute
	[to our patch list][patches].

The generated header file `modm/platform/device.hpp` contains the necessary
target define `STM32{FAMILY}{NAME}xx` or similar and includes the
`modm:target`-specific header.

!!! tip "Include only `modm/platform/device.hpp`!"
	This file is only included by interface implementations inside the
	`modm/platform` folder! If you need to implement your own drivers, include
	only this file.


## CMSIS Compliance

modm implements the target specific CMSIS functionality itself, without using
the CMSIS interface. This is necessary to provide similar functionality on
non-Cortex-M based targets.

Specifically, these functions are not implemented:

- `uint32_t SystemCoreClock` and `void SystemCoreClockUpdate()`: please use
  `modm::clock::f_cpu` as defined in the `modm:architecture:clock` module.
- `void SystemInit()`: modm defines its own startup architecture, see the
  `modm:platform:core` module for details.


[repo]: https://github.com/modm-io/cmsis-header-stm32
[patches]: https://github.com/modm-io/cmsis-header-stm32/tree/master/patches


## Debugging Peripherals

When debugging with GDB, it can sometimes be difficult to access peripherals,
due to the CMSIS implementation with CPP defines and GCC optimization flags.
Depending on these circumstances, GDB may only "see" a peripheral in a certain
context, which can make the debugging experience quite frustrating.

To aid this, we generate a linkerscript fragment and source file, which place
the peripherals memory as real objects in the peripheral memory space.
You can then access these peripherals inside GDB at any time, regardless of
context and build profile setting:

```
(gdb) p/x *GPIOB
$1 = {
  MODER = 0xaa0280,
  OTYPER = 0x300,
  OSPEEDR = 0x2a00c0,
  PUPDR = 0x400100,
  IDR = 0xfd0,
  ODR = 0x100,
  BSRR = 0x0,
  LCKR = 0x0,
  AFR = {0x0, 0x7744}
}
```

**This does not have any effect on your firmware!** It is purely a debug
helper feature and none of these definitions make it into the executable.

!!! tip "Beware read/write side-effects"
    When debugging be aware of the side-effects that your read or write to a
    peripheral memory location can have. It's fairly obvious that a write may
    have consequences, but also reads can modify peripheral state, for example,
    a hardware FIFO buffer may pop the queue if your read the top of it.






## Dependencies

<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"
 "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">
<!-- Generated by graphviz version 2.38.0 (20140413.2041)
 -->
<!-- Title: modm:cmsis:device Pages: 1 -->
<svg width="690pt" height="239pt"
 viewBox="0.00 0.00 690.00 239.00" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
<g id="graph0" class="graph" transform="scale(1 1) rotate(0) translate(4 235)">
<title>modm:cmsis:device</title>
<polygon fill="white" stroke="none" points="-4,4 -4,-235 686,-235 686,4 -4,4"/>
<!-- modm_cmsis_device -->
<g id="node1" class="node"><title>modm_cmsis_device</title>
<polygon fill="lightgrey" stroke="black" stroke-width="2" points="378.5,-142 322.5,-142 322.5,-89 378.5,-89 378.5,-142"/>
<text text-anchor="middle" x="350.5" y="-126.8" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="350.5" y="-111.8" font-family="Times New Roman,serif" font-size="14.00">cmsis:</text>
<text text-anchor="middle" x="350.5" y="-96.8" font-family="Times New Roman,serif" font-size="14.00">device</text>
</g>
<!-- modm_cmsis -->
<g id="node2" class="node"><title>modm_cmsis</title>
<g id="a_node2"><a xlink:href="../modm-cmsis" xlink:title="modm:
cmsis">
<polygon fill="lightgrey" stroke="black" points="341.5,-223.5 285.5,-223.5 285.5,-185.5 341.5,-185.5 341.5,-223.5"/>
<text text-anchor="middle" x="313.5" y="-208.3" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="313.5" y="-193.3" font-family="Times New Roman,serif" font-size="14.00">cmsis</text>
</a>
</g>
</g>
<!-- modm_cmsis_device&#45;&gt;modm_cmsis -->
<g id="edge1" class="edge"><title>modm_cmsis_device&#45;&gt;modm_cmsis</title>
<path fill="none" stroke="black" d="M339.599,-142.132C335.062,-152.801 329.787,-165.204 325.171,-176.057"/>
<polygon fill="black" stroke="black" points="321.851,-174.921 321.158,-185.493 328.293,-177.661 321.851,-174.921"/>
</g>
<!-- modm_cmsis_core -->
<g id="node3" class="node"><title>modm_cmsis_core</title>
<g id="a_node3"><a xlink:href="../modm-cmsis-core" xlink:title="modm:
cmsis:
core">
<polygon fill="lightgrey" stroke="black" points="415.5,-231 359.5,-231 359.5,-178 415.5,-178 415.5,-231"/>
<text text-anchor="middle" x="387.5" y="-215.8" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="387.5" y="-200.8" font-family="Times New Roman,serif" font-size="14.00">cmsis:</text>
<text text-anchor="middle" x="387.5" y="-185.8" font-family="Times New Roman,serif" font-size="14.00">core</text>
</a>
</g>
</g>
<!-- modm_cmsis_device&#45;&gt;modm_cmsis_core -->
<g id="edge2" class="edge"><title>modm_cmsis_device&#45;&gt;modm_cmsis_core</title>
<path fill="none" stroke="black" d="M361.401,-142.132C364.908,-150.378 368.855,-159.659 372.598,-168.46"/>
<polygon fill="black" stroke="black" points="369.414,-169.918 376.549,-177.75 375.856,-167.178 369.414,-169.918"/>
</g>
<!-- modm_platform_can -->
<g id="node4" class="node"><title>modm_platform_can</title>
<g id="a_node4"><a xlink:href="../modm-platform-can" xlink:title="modm:
platform:
can">
<polygon fill="lightgrey" stroke="black" points="67,-53 0,-53 0,-0 67,-0 67,-53"/>
<text text-anchor="middle" x="33.5" y="-37.8" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="33.5" y="-22.8" font-family="Times New Roman,serif" font-size="14.00">platform:</text>
<text text-anchor="middle" x="33.5" y="-7.8" font-family="Times New Roman,serif" font-size="14.00">can</text>
</a>
</g>
</g>
<!-- modm_platform_can&#45;&gt;modm_cmsis_device -->
<g id="edge3" class="edge"><title>modm_platform_can&#45;&gt;modm_cmsis_device</title>
<path fill="none" stroke="black" d="M67.4047,-49.3258C70.093,-50.6711 72.8096,-51.9166 75.5,-53 156.335,-85.5525 257.818,-102.579 312.08,-109.926"/>
<polygon fill="black" stroke="black" points="311.911,-113.434 322.282,-111.268 312.824,-106.494 311.911,-113.434"/>
</g>
<!-- modm_platform_clock -->
<g id="node5" class="node"><title>modm_platform_clock</title>
<g id="a_node5"><a xlink:href="../modm-platform-clock" xlink:title="modm:
platform:
clock">
<polygon fill="lightgrey" stroke="black" points="152,-53 85,-53 85,-0 152,-0 152,-53"/>
<text text-anchor="middle" x="118.5" y="-37.8" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="118.5" y="-22.8" font-family="Times New Roman,serif" font-size="14.00">platform:</text>
<text text-anchor="middle" x="118.5" y="-7.8" font-family="Times New Roman,serif" font-size="14.00">clock</text>
</a>
</g>
</g>
<!-- modm_platform_clock&#45;&gt;modm_cmsis_device -->
<g id="edge4" class="edge"><title>modm_platform_clock&#45;&gt;modm_cmsis_device</title>
<path fill="none" stroke="black" d="M152.402,-48.5233C155.435,-50.1224 158.495,-51.6403 161.5,-53 212.002,-75.8523 273.546,-94.2415 312.388,-104.77"/>
<polygon fill="black" stroke="black" points="311.668,-108.201 322.233,-107.402 313.476,-101.438 311.668,-108.201"/>
</g>
<!-- modm_platform_clock_cortex -->
<g id="node6" class="node"><title>modm_platform_clock_cortex</title>
<g id="a_node6"><a xlink:href="../modm-platform-clock-cortex" xlink:title="modm:
platform:
clock.cortex">
<polygon fill="lightgrey" stroke="black" points="256.5,-53 170.5,-53 170.5,-0 256.5,-0 256.5,-53"/>
<text text-anchor="middle" x="213.5" y="-37.8" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="213.5" y="-22.8" font-family="Times New Roman,serif" font-size="14.00">platform:</text>
<text text-anchor="middle" x="213.5" y="-7.8" font-family="Times New Roman,serif" font-size="14.00">clock.cortex</text>
</a>
</g>
</g>
<!-- modm_platform_clock_cortex&#45;&gt;modm_cmsis_device -->
<g id="edge5" class="edge"><title>modm_platform_clock_cortex&#45;&gt;modm_cmsis_device</title>
<path fill="none" stroke="black" d="M253.864,-53.1323C272.806,-65.1614 295.223,-79.3968 313.695,-91.1272"/>
<polygon fill="black" stroke="black" points="311.827,-94.0871 322.145,-96.4933 315.579,-88.1779 311.827,-94.0871"/>
</g>
<!-- modm_platform_core -->
<g id="node7" class="node"><title>modm_platform_core</title>
<g id="a_node7"><a xlink:href="../modm-platform-core" xlink:title="modm:
platform:
core">
<polygon fill="lightgrey" stroke="black" points="342,-53 275,-53 275,-0 342,-0 342,-53"/>
<text text-anchor="middle" x="308.5" y="-37.8" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="308.5" y="-22.8" font-family="Times New Roman,serif" font-size="14.00">platform:</text>
<text text-anchor="middle" x="308.5" y="-7.8" font-family="Times New Roman,serif" font-size="14.00">core</text>
</a>
</g>
</g>
<!-- modm_platform_core&#45;&gt;modm_cmsis_device -->
<g id="edge6" class="edge"><title>modm_platform_core&#45;&gt;modm_cmsis_device</title>
<path fill="none" stroke="black" d="M320.874,-53.1323C324.897,-61.4652 329.431,-70.8569 333.72,-79.7412"/>
<polygon fill="black" stroke="black" points="330.57,-81.2664 338.069,-88.7503 336.873,-78.2231 330.57,-81.2664"/>
</g>
<!-- modm_platform_gpio -->
<g id="node8" class="node"><title>modm_platform_gpio</title>
<g id="a_node8"><a xlink:href="../modm-platform-gpio" xlink:title="modm:
platform:
gpio">
<polygon fill="lightgrey" stroke="black" points="427,-53 360,-53 360,-0 427,-0 427,-53"/>
<text text-anchor="middle" x="393.5" y="-37.8" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="393.5" y="-22.8" font-family="Times New Roman,serif" font-size="14.00">platform:</text>
<text text-anchor="middle" x="393.5" y="-7.8" font-family="Times New Roman,serif" font-size="14.00">gpio</text>
</a>
</g>
</g>
<!-- modm_platform_gpio&#45;&gt;modm_cmsis_device -->
<g id="edge7" class="edge"><title>modm_platform_gpio&#45;&gt;modm_cmsis_device</title>
<path fill="none" stroke="black" d="M380.831,-53.1323C376.713,-61.4652 372.071,-70.8569 367.68,-79.7412"/>
<polygon fill="black" stroke="black" points="364.52,-78.2346 363.227,-88.7503 370.795,-81.3363 364.52,-78.2346"/>
</g>
<!-- modm_platform_i2c -->
<g id="node9" class="node"><title>modm_platform_i2c</title>
<g id="a_node9"><a xlink:href="../modm-platform-i2c" xlink:title="modm:
platform:
i2c">
<polygon fill="lightgrey" stroke="black" points="512,-53 445,-53 445,-0 512,-0 512,-53"/>
<text text-anchor="middle" x="478.5" y="-37.8" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="478.5" y="-22.8" font-family="Times New Roman,serif" font-size="14.00">platform:</text>
<text text-anchor="middle" x="478.5" y="-7.8" font-family="Times New Roman,serif" font-size="14.00">i2c</text>
</a>
</g>
</g>
<!-- modm_platform_i2c&#45;&gt;modm_cmsis_device -->
<g id="edge8" class="edge"><title>modm_platform_i2c&#45;&gt;modm_cmsis_device</title>
<path fill="none" stroke="black" d="M444.87,-50.3582C427.174,-62.3859 405.445,-77.1545 387.3,-89.4874"/>
<polygon fill="black" stroke="black" points="385.017,-86.8073 378.714,-95.3234 388.952,-92.5966 385.017,-86.8073"/>
</g>
<!-- modm_platform_spi -->
<g id="node10" class="node"><title>modm_platform_spi</title>
<g id="a_node10"><a xlink:href="../modm-platform-spi" xlink:title="modm:
platform:
spi">
<polygon fill="lightgrey" stroke="black" points="597,-53 530,-53 530,-0 597,-0 597,-53"/>
<text text-anchor="middle" x="563.5" y="-37.8" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="563.5" y="-22.8" font-family="Times New Roman,serif" font-size="14.00">platform:</text>
<text text-anchor="middle" x="563.5" y="-7.8" font-family="Times New Roman,serif" font-size="14.00">spi</text>
</a>
</g>
</g>
<!-- modm_platform_spi&#45;&gt;modm_cmsis_device -->
<g id="edge9" class="edge"><title>modm_platform_spi&#45;&gt;modm_cmsis_device</title>
<path fill="none" stroke="black" d="M529.898,-48.6975C527.094,-50.2216 524.271,-51.6768 521.5,-53 477.319,-74.0944 423.867,-92.2132 388.618,-103.213"/>
<polygon fill="black" stroke="black" points="387.263,-99.9676 378.738,-106.258 389.325,-106.657 387.263,-99.9676"/>
</g>
<!-- modm_platform_uart -->
<g id="node11" class="node"><title>modm_platform_uart</title>
<g id="a_node11"><a xlink:href="../modm-platform-uart" xlink:title="modm:
platform:
uart">
<polygon fill="lightgrey" stroke="black" points="682,-53 615,-53 615,-0 682,-0 682,-53"/>
<text text-anchor="middle" x="648.5" y="-37.8" font-family="Times New Roman,serif" font-size="14.00">modm:</text>
<text text-anchor="middle" x="648.5" y="-22.8" font-family="Times New Roman,serif" font-size="14.00">platform:</text>
<text text-anchor="middle" x="648.5" y="-7.8" font-family="Times New Roman,serif" font-size="14.00">uart</text>
</a>
</g>
</g>
<!-- modm_platform_uart&#45;&gt;modm_cmsis_device -->
<g id="edge10" class="edge"><title>modm_platform_uart&#45;&gt;modm_cmsis_device</title>
<path fill="none" stroke="black" d="M614.576,-49.2781C611.892,-50.6344 609.182,-51.8954 606.5,-53 532.362,-83.5364 439.628,-101.1 388.592,-109.132"/>
<polygon fill="black" stroke="black" points="388.01,-105.68 378.657,-110.658 389.072,-112.599 388.01,-105.68"/>
</g>
</g>
</svg>

